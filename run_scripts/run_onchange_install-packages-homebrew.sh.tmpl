#!/bin/bash

# Only run on macOS
{{ if eq .chezmoi.os "darwin" -}}

# Install Homebrew if not installed
if ! command -v brew &> /dev/null; then
  echo "Installing Homebrew..."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

# Update Homebrew
echo "Updating Homebrew..."
brew update

# Make sure brew-file is installed
if ! command -v brew-file &> /dev/null; then
  echo "Installing brew-file..."
  brew install rcmdnk/file/brew-file
fi

# Ensure brewfile directory exists
mkdir -p {{ .chezmoi.homeDir }}/.config/brewfile

# Generate Brewfile based on machine type
echo "# Generated Brewfile - DO NOT EDIT DIRECTLY" > {{ .chezmoi.homeDir }}/.config/brewfile/Brewfile
echo "# Source: {{ .chezmoi.sourceDir }}/.chezmoidata/packages.yaml" >> {{ .chezmoi.homeDir }}/.config/brewfile/Brewfile
echo "# Machine type: {{ .machine_type }}" >> {{ .chezmoi.homeDir }}/.config/brewfile/Brewfile
echo "" >> {{ .chezmoi.homeDir }}/.config/brewfile/Brewfile

# Add taps
echo "# Taps" >> {{ .chezmoi.homeDir }}/.config/brewfile/Brewfile
{{ range .packages.taps -}}
echo "tap {{ . | quote }}" >> {{ .chezmoi.homeDir }}/.config/brewfile/Brewfile
{{ end -}}
echo "" >> {{ .chezmoi.homeDir }}/.config/brewfile/Brewfile

# Always include common packages
echo "# Common packages" >> {{ .chezmoi.homeDir }}/.config/brewfile/Brewfile
{{ range .packages.common.brews -}}
echo "brew {{ . | quote }}" >> {{ .chezmoi.homeDir }}/.config/brewfile/Brewfile
{{ end -}}
echo "" >> {{ .chezmoi.homeDir }}/.config/brewfile/Brewfile

{{ if .packages.common.casks -}}
{{ range .packages.common.casks -}}
echo "cask {{ . | quote }}" >> {{ .chezmoi.homeDir }}/.config/brewfile/Brewfile
{{ end -}}
echo "" >> {{ .chezmoi.homeDir }}/.config/brewfile/Brewfile
{{ end -}}

{{ if .packages.common.mas -}}
{{ range .packages.common.mas -}}
echo "appstore {{ .id }} {{ .name }}" >> {{ .chezmoi.homeDir }}/.config/brewfile/Brewfile
{{ end -}}
echo "" >> {{ .chezmoi.homeDir }}/.config/brewfile/Brewfile
{{ end -}}

# Include machine-specific packages
{{ if eq .machine_type "coding" }}
echo "# Coding packages" >> {{ .chezmoi.homeDir }}/.config/brewfile/Brewfile
{{ range .packages.coding.brews -}}
echo "brew {{ . | quote }}" >> {{ .chezmoi.homeDir }}/.config/brewfile/Brewfile
{{ end -}}
echo "" >> {{ .chezmoi.homeDir }}/.config/brewfile/Brewfile

{{ if .packages.coding.casks -}}
{{ range .packages.coding.casks -}}
echo "cask {{ . | quote }}" >> {{ .chezmoi.homeDir }}/.config/brewfile/Brewfile
{{ end -}}
echo "" >> {{ .chezmoi.homeDir }}/.config/brewfile/Brewfile
{{ end -}}

{{ if .packages.coding.mas -}}
{{ range .packages.coding.mas -}}
echo "appstore {{ .id }} {{ .name }}" >> {{ .chezmoi.homeDir }}/.config/brewfile/Brewfile
{{ end -}}
echo "" >> {{ .chezmoi.homeDir }}/.config/brewfile/Brewfile
{{ end -}}
{{ else }}
echo "# Personal packages" >> {{ .chezmoi.homeDir }}/.config/brewfile/Brewfile
{{ range .packages.personal.brews -}}
echo "brew {{ . | quote }}" >> {{ .chezmoi.homeDir }}/.config/brewfile/Brewfile
{{ end -}}
echo "" >> {{ .chezmoi.homeDir }}/.config/brewfile/Brewfile

{{ if .packages.personal.mas -}}
{{ range .packages.personal.mas -}}
echo "appstore {{ .id }} {{ .name }}" >> {{ .chezmoi.homeDir }}/.config/brewfile/Brewfile
{{ end -}}
echo "" >> {{ .chezmoi.homeDir }}/.config/brewfile/Brewfile
{{ end -}}
{{ end }}

# Set HOMEBREW_BREWFILE for brew-file
export HOMEBREW_BREWFILE="{{ .chezmoi.homeDir }}/.config/brewfile/Brewfile"

# Set up brew-wrap if not already configured
BREW_WRAP_PATH="$(brew --prefix)/etc/brew-wrap"
SHELL_CONFIG="${HOME}/.zshrc"  # Adjust if using a different shell

if [ -f "$BREW_WRAP_PATH" ]; then
  echo "Setting up brew-wrap..."

  # Check if brew-wrap is already in shell config
  if ! grep -q "source.*brew-wrap" "$SHELL_CONFIG"; then
    echo "Adding brew-wrap to shell config..."
    echo "" >> "$SHELL_CONFIG"
    echo "# Set up brew-wrap for automatic Brewfile updates" >> "$SHELL_CONFIG"
    echo "if [ -f \$(brew --prefix)/etc/brew-wrap ]; then" >> "$SHELL_CONFIG"
    echo "  source \$(brew --prefix)/etc/brew-wrap" >> "$SHELL_CONFIG"
    echo "" >> "$SHELL_CONFIG"
    echo "  # Fix @ symbols in Brewfile after updates" >> "$SHELL_CONFIG"
    echo "  _post_brewfile_update() {" >> "$SHELL_CONFIG"
    echo "    sed -i '' 's/brew \([a-zA-Z0-9_-]*@[0-9.]*\)/brew \"\1\"/g' \"\$HOMEBREW_BREWFILE\"" >> "$SHELL_CONFIG"
    echo "    echo \"Brewfile updated! To add new packages to your dotfiles:\"" >> "$SHELL_CONFIG"
    echo "    echo \"chezmoi edit .chezmoidata/packages.yaml\"" >> "$SHELL_CONFIG"
    echo "  }" >> "$SHELL_CONFIG"
    echo "fi" >> "$SHELL_CONFIG"

    echo "brew-wrap has been added to $SHELL_CONFIG"
    echo "Please restart your shell or run 'source $SHELL_CONFIG' to activate it"
  else
    echo "brew-wrap is already configured in $SHELL_CONFIG"
  fi
fi

# Install packages using brew-file
echo "Installing packages using brew-file..."
brew file install -f

{{ end -}}